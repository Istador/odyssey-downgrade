name: Build artifacts


inputs:
  tag:
    description : 'version tag'
    required    : false
    default     : ''


outputs:
  filename:
    description : 'Filename for the build artifacts'
    value       : ${{ steps.env.outputs.filename }}


runs:
  using: composite
  steps:
  -
    name  : Environment
    id    : env
    shell : bash
    run: |
      VERS=${{ inputs.tag }}
      echo "::set-output name=version::${VERS:1}"
      echo "::set-output name=filename::odyssey_downgrade"
  -
    name : Set up Docker Buildx
    uses : docker/setup-buildx-action@v2
  -
    name : Build environment
    uses : docker/build-push-action@v3
    with:
      pull       : true
      push       : false
      load       : true
      context    : .
      file       : ./Dockerfile
      tags       : smo-downgrade-build
      platforms  : linux/amd64
      cache-from : type=gha,scope=smo-downgrade-build
      cache-to   : type=gha,scope=smo-downgrade-build,mode=max
  -
    name  : Build mod
    shell : bash
    run: |
      ./docker-build.sh  ${{ (steps.env.outputs.version != '' && steps.env.outputs.version) || '' }}
  -
    name : Upload artifacts
    uses : actions/upload-artifact@v3
    with:
      name              : ${{ steps.env.outputs.filename }}
      path              : ./out/
      if-no-files-found : error
